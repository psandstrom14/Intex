<!--Paris Ward, Lucas Moraes, Joshua Ethington, Parker Sandstrom-->
<!--This page will dispaly participants, and allow CRUD (for managers) + Search Capabilities.-->
<!--This page will only be visible to users who are logged in.-->
<!--Ability to maintain milestones for participants-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participants - Ella Rises</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">Ella Rises</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/donate_now">Donate Now</a></li>
                <li class="dropdown">
                    <span class="dropdown-toggle">
                        <a href="#" class="selected-nav">Pages â–¾</a>
                    </span>
                    <ul class="dropdown-menu">
                        <li><a href="/users">Users</a></li>
                        <li><a href="/participants">Participants</a></li>
                        <li><a href="/events">Events</a></li>
                        <li><a href="/surveys">Surveys</a></li>
                        <li><a href="/milestones">Milestones</a></li>
                        <li><a href="/donations">Donations</a></li>
                    </ul>
                </li>
                <li><a href="/login" class="login-btn">Login</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Participants</h1>
        <p>Manage and view all participant information</p>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Success/Error Messages -->
        <% if (typeof message !== 'undefined' && message) { %>
            <div class="alert alert-<%= messageType || 'success' %>">
                <%= message %>
            </div>
        <% } %>

        <!-- Search and Actions Bar -->
        <div class="table-container">
            <div class="table-header">
                <h2 class="table-title">All Participants</h2>
                <div class="table-actions">
                    <button class="btn btn-primary" onclick="window.location.href='/participants/add'">
                        + Add Participant
                    </button>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="filter-section">
                <div class="filter-row">
                    <!-- Basic Search -->
                    <div class="filter-item" style="flex: 2;">
                        <label class="form-label">Quick Search (First Name)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="quickSearch" class="form-control" placeholder="Search by first name...">
                            <button class="btn btn-primary" id="quickSearchBtn" style="white-space: nowrap;">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Toggle -->
                    <div class="filter-item" style="flex: 0.8;">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-secondary" id="toggleAdvancedSearch" style="width: 100%;">
                            Advanced Search
                        </button>
                    </div>
                </div>

                <!-- Advanced Search (Hidden by default) -->
                <div id="advancedSearchSection" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e0e0e0;">
                    <h3 style="color: #7eb8b8; margin-bottom: 1rem; font-size: 1.1rem;">Advanced Search</h3>
                    <div class="filter-row">
                        <div class="filter-item">
                            <label class="form-label">Search Field</label>
                            <select id="advancedSearchColumn" class="form-control">
                                <option value="">All Fields</option>
                                <option value="firstname">First Name</option>
                                <option value="lastname">Last Name</option>
                                <option value="email">Email</option>
                                <option value="phone">Phone</option>
                                <option value="city">City</option>
                                <option value="state">State</option>
                                <option value="school">School/Employer</option>
                                <option value="interest">Field of Interest</option>
                            </select>
                        </div>
                        <div class="filter-item" style="flex: 2;">
                            <label class="form-label">Search Value</label>
                            <input type="text" id="advancedSearchValue" class="form-control" placeholder="Enter search term...">
                        </div>
                        <div class="filter-item">
                            <label class="form-label">Sort By</label>
                            <select id="sortColumn" class="form-control">
                                <option value="firstname">First Name</option>
                                <option value="lastname">Last Name</option>
                                <option value="email">Email</option>
                                <option value="phone">Phone</option>
                                <option value="dob">Date of Birth</option>
                                <option value="city">City</option>
                                <option value="donations">Total Donations</option>
                            </select>
                        </div>
                        <div class="filter-item" style="flex: 0.5;">
                            <label class="form-label">Order</label>
                            <select id="sortOrder" class="form-control">
                                <option value="asc">A-Z</option>
                                <option value="desc">Z-A</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-row" style="margin-top: 1rem;">
                        <div class="filter-item" style="flex: 0.8;">
                            <button class="btn btn-primary btn-small" id="applyAdvancedSearch" style="width: 100%;">
                                Apply Filter
                            </button>
                        </div>
                        <div class="filter-item" style="flex: 0.8;">
                            <button class="btn btn-outline btn-small" id="clearAdvancedSearch" style="width: 100%;">
                                Clear Filter
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar (Hidden by default) -->
            <div id="bulkActionsBar" style="display: none; background-color: #f8f0f0; padding: 1rem 1.5rem; border-bottom: 1px solid #e0e0e0;">
                <div class="flex-between">
                    <div>
                        <span id="selectedCount" style="font-weight: 600; color: #666;">0 selected</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-small" id="editSelected" style="display: none;">
                            Edit
                        </button>
                        <button class="btn btn-danger btn-small" id="deleteSelected">
                            Delete Selected
                        </button>
                        <button class="btn btn-outline btn-small" id="clearSelection">
                            Clear Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll">
                            </th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Date of Birth</th>
                            <th>City</th>
                            <th>State</th>
                            <th>Zip</th>
                            <th>School/Employer</th>
                            <th>Field of Interest</th>
                            <th>Total Donations</th>
                            <th style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be inserted here from your backend -->
                        <% if (typeof participants !== 'undefined' && participants.length > 0) { %>
                            <% participants.forEach(function(participant) { %>
                                <tr data-id="<%= participant.id %>">
                                    <td>
                                        <input type="checkbox" class="row-checkbox" value="<%= participant.id %>">
                                    </td>
                                    <td><%= participant.ParticipantFirstName %></td>
                                    <td><%= participant.ParticipantLastName %></td>
                                    <td><%= participant.ParticipantEmail %></td>
                                    <td><%= participant.ParticipantPhone %></td>
                                    <td><%= participant.ParticipantDOB %></td>
                                    <td><%= participant.ParticipantCity %></td>
                                    <td><%= participant.ParticipantState %></td>
                                    <td><%= participant.ParticipantZip %></td>
                                    <td><%= participant.ParticipantSchoolOrEmployer %></td> 
                                    <td><%= participant.ParticipantFieldOfInterest %></td> 
                                    <td>$<%= participant.TotalDonations %></td>
                                    <td style="text-align: center;">
                                        <div class="row-actions" style="justify-content: center;">
                                            <button class="btn btn-secondary btn-small" onclick="window.location.href='/participants/edit/<%= participant.id %>'">
                                                Edit
                                            </button>
                                            <button class="btn btn-danger btn-small" onclick="confirmDelete('<%= participant.id %>', '<%= participant.ParticipantFirstName %> <%= participant.ParticipantLastName %>')">
                                                Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            <% }); %>
                        <% } else { %>
                            <tr>
                                <td colspan="13" style="text-align: center; padding: 3rem; color: #999;">
                                    No participants found. Click "Add Participant" to get started.
                                </td>
                            </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <button id="prevPage" class="btn-small">Previous</button>
                <button class="btn-small active">1</button>
                <button class="btn-small">2</button>
                <button class="btn-small">3</button>
                <button id="nextPage" class="btn-small">Next</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Ella Rises. All Rights Reserved.</p>
        <p style="margin-top: 1rem; font-size: 0.9rem;">Making a difference, one woman at a time.</p>
    </footer>

    <script>
        // Dropdown handling
        let dropdownTimeout;
        const dropdown = document.querySelector('.dropdown');
        const dropdownMenu = document.querySelector('.dropdown-menu');

        if (dropdown && dropdownMenu) {
            dropdown.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdown.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });

            dropdownMenu.addEventListener('mouseenter', function() {
                clearTimeout(dropdownTimeout);
                dropdownMenu.style.display = 'block';
            });

            dropdownMenu.addEventListener('mouseleave', function() {
                dropdownTimeout = setTimeout(function() {
                    dropdownMenu.style.display = 'none';
                }, 200);
            });
        }

        // Advanced Search Toggle
        document.getElementById('toggleAdvancedSearch').addEventListener('click', function() {
            const advSection = document.getElementById('advancedSearchSection');
            if (advSection.style.display === 'none') {
                advSection.style.display = 'block';
                this.textContent = 'Hide Advanced';
            } else {
                advSection.style.display = 'none';
                this.textContent = 'Advanced Search';
            }
        });

        // Checkbox Selection Handling
        const selectAllCheckbox = document.getElementById('selectAll');
        const rowCheckboxes = document.querySelectorAll('.row-checkbox');
        const bulkActionsBar = document.getElementById('bulkActionsBar');
        const selectedCountSpan = document.getElementById('selectedCount');
        const editButton = document.getElementById('editSelected');

        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActions();
        });

        rowCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateBulkActions);
        });

        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const count = checkedBoxes.length;

            if (count > 0) {
                bulkActionsBar.style.display = 'block';
                selectedCountSpan.textContent = count + ' selected';
                
                // Show edit button only if exactly one is selected
                if (count === 1) {
                    editButton.style.display = 'inline-block';
                } else {
                    editButton.style.display = 'none';
                }
            } else {
                bulkActionsBar.style.display = 'none';
                editButton.style.display = 'none';
            }

            // Update select all checkbox
            selectAllCheckbox.checked = count === rowCheckboxes.length && count > 0;
        }

        // Clear Selection
        document.getElementById('clearSelection').addEventListener('click', function() {
            rowCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectAllCheckbox.checked = false;
            updateBulkActions();
        });

        // Edit Selected (single item)
        document.getElementById('editSelected').addEventListener('click', function() {
            const checkedBox = document.querySelector('.row-checkbox:checked');
            if (checkedBox) {
                const participantId = checkedBox.value;
                window.location.href = '/participants/edit/' + participantId;
            }
        });

        // Delete Selected (bulk)
        document.getElementById('deleteSelected').addEventListener('click', function() {
            const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
            const ids = Array.from(checkedBoxes).map(cb => cb.value);
            const count = ids.length;
            
            const confirmMessage = count === 1 
                ? 'Are you sure you want to delete this participant?' 
                : `Are you sure you want to delete ${count} participants?`;
            
            showDeleteConfirmation(confirmMessage, function() {
                // Submit deletion form
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/participants/delete-multiple';
                
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'ids';
                input.value = JSON.stringify(ids);
                form.appendChild(input);
                
                document.body.appendChild(form);
                form.submit();
            });
        });

        // Delete Single Item
        function confirmDelete(id, name) {
            showDeleteConfirmation(`Are you sure you want to delete ${name}?`, function() {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/participants/delete/' + id;
                document.body.appendChild(form);
                form.submit();
            });
        }

        // Delete Confirmation Modal
        function showDeleteConfirmation(message, onConfirm) {
            // Create modal overlay
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'deleteModal';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Confirm Deletion</h3>
                        <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p style="font-size: 1.1rem; color: #666;">${message}</p>
                        <p style="margin-top: 1rem; color: #999;">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                        <button class="btn btn-danger" id="confirmDeleteBtn">Yes, Delete</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Add confirm handler
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                closeDeleteModal();
                onConfirm();
            });
            
            // Close on overlay click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDeleteModal();
                }
            });
        }

        function closeDeleteModal() {
            const modal = document.getElementById('deleteModal');
            if (modal) {
                modal.remove();
            }
        }

        // Quick Search (client-side filtering - First Name only)
        const quickSearchInput = document.getElementById('quickSearch');
        const quickSearchBtn = document.getElementById('quickSearchBtn');
        
        function performQuickSearch() {
            const searchTerm = quickSearchInput.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr[data-id]');
            
            rows.forEach(row => {
                // First Name is in column index 1 (after checkbox)
                const firstName = row.cells[1]?.textContent.toLowerCase() || '';
                
                if (firstName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Search on button click
        quickSearchBtn.addEventListener('click', performQuickSearch);
        
        // Also search on Enter key
        quickSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performQuickSearch();
            }
        });

        // Sort functionality (will trigger a server request)
        document.getElementById('sortColumn').addEventListener('change', updateSortingInURL);
        document.getElementById('sortOrder').addEventListener('change', updateSortingInURL);

        function updateSortingInURL() {
            // This will be called from advanced search, so don't auto-apply
            // The apply button will handle the submission
        }

        function applySorting() {
            const column = document.getElementById('sortColumn').value;
            const order = document.getElementById('sortOrder').value;
            window.location.href = '/participants?sort=' + column + '&order=' + order;
        }

        // Advanced Search
        document.getElementById('applyAdvancedSearch').addEventListener('click', function() {
            const column = document.getElementById('advancedSearchColumn').value;
            const value = document.getElementById('advancedSearchValue').value;
            const sortColumn = document.getElementById('sortColumn').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            let url = '/participants?';
            
            if (column && value) {
                url += 'searchColumn=' + column + '&searchValue=' + encodeURIComponent(value);
            }
            
            // Add sorting parameters
            url += '&sort=' + sortColumn + '&order=' + sortOrder;
            
            window.location.href = url;
        });

        document.getElementById('clearAdvancedSearch').addEventListener('click', function() {
            document.getElementById('advancedSearchColumn').value = '';
            document.getElementById('advancedSearchValue').value = '';
            window.location.href = '/participants';
        });

        // Auto-hide success/error messages after 5 seconds
        const alertMessages = document.querySelectorAll('.alert');
        alertMessages.forEach(alert => {
            setTimeout(() => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        });
    </script>
</body>
</html>