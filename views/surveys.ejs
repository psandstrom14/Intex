<!--Paris Ward, Lucas Moraes, Joshua Ethington, Parker Sandstrom-->
<!--This page will display surveys, and allow CRUD (for managers) + Search/Filter/Sort capabilities.-->
<!--This page will only be visible to users who are logged in.-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveys - Ella Rises</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo">
                <a href="/"><img src="/images/logo.png" alt="Ella Rises Logo"> ELLA RISES</a>
            </div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/about">About</a></li>
                <li><a href="/donate_now">Donate Now</a></li>
                <li class="dropdown">
                    <span class="dropdown-toggle">
                        <a href="#" class="selected-nav">Pages ▾</a>
                    </span>
                    <ul class="dropdown-menu">
                        <li><a href="/users">Users</a></li>
                        <li><a href="/participants">Participants</a></li>
                        <li><a href="/events">Events</a></li>
                        <li><a href="/surveys">Surveys</a></li>
                        <li><a href="/milestones">Milestones</a></li>
                        <li><a href="/donations">Donations</a></li>
                    </ul>
                </li>
                <li><a href="/login" class="login-btn">Login</a></li>
            </ul>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Surveys</h1>
            <p>View and manage survey responses</p>
        </div>
    </section>

    <!-- Database Content -->
    <div class="container">
        <!-- Success/Error Messages -->
        <% if (typeof message !== 'undefined' && message) { %>
            <div class="alert alert-<%= messageType || 'success' %>">
                <%= message %>
            </div>
        <% } %>

        <div class="table-container">
            <!-- Header -->
            <div class="table-header">
                <h2 class="table-title">Ella Rises Surveys</h2>
                <!--UPDATE LATER: "add" button should only show for managers-->
                <div class="table-actions">
                    <button class="btn btn-add"><a href="/add/surveys">+ Add Survey</a></button>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="filter-section">
                <!-- SEARCH FORM -->
                <form id="searchForm" method="POST" action="/filter-surveys">
                    <div class="filter-row">
                        <!-- Search Column Dropdown -->
                        <div class="filter-item filter-column">
                            <select name="searchColumn" id="searchColumn" class="form-control">
                                <option value="survey_id" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_id') ? 'selected' : (!filters || !filters.searchColumn) ? 'selected' : '' %>>Survey ID</option>
                                <option value="participant_event_id" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'participant_event_id') ? 'selected' : '' %>>Participant Event ID</option>
                                <option value="survey_satisfaction_score" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_satisfaction_score') ? 'selected' : '' %>>Satisfaction Score</option>
                                <option value="survey_usefulness_score" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_usefulness_score') ? 'selected' : '' %>>Usefulness Score</option>
                                <option value="survey_instructor_score" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_instructor_score') ? 'selected' : '' %>>Instructor Score</option>
                                <option value="survey_recommendation_score" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_recommendation_score') ? 'selected' : '' %>>Recommendation Score</option>
                                <option value="survey_overall_score" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_overall_score') ? 'selected' : '' %>>Overall Score</option>
                                <option value="survey_nps_bucket" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_nps_bucket') ? 'selected' : '' %>>NPS Bucket</option>
                                <option value="survey_comments" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_comments') ? 'selected' : '' %>>Comments</option>
                                <option value="survey_submission_date" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_submission_date') ? 'selected' : '' %>>Submission Date</option>
                                <option value="survey_submission_time" <%= (typeof filters !== 'undefined' && filters.searchColumn === 'survey_submission_time') ? 'selected' : '' %>>Submission Time</option>
                            </select>
                        </div>

                        <!-- Search box + buttons -->
                        <div class="filter-item filter-search">
                            <div class="search-input-group">
                                <input
                                    type="text"
                                    name="searchValue"
                                    id="searchValue"
                                    class="form-control"
                                    placeholder="Search..."
                                    value="<%= (typeof filters !== 'undefined' && filters.searchValue) ? filters.searchValue : '' %>"
                                >
                                <button type="submit" class="btn btn-primary">Search</button>
                                <button type="button" class="btn btn-secondary filter-toggle-btn" id="toggleFilters">
                                    <span id="filterButtonText">Filters</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden inputs to preserve sorting -->
                    <input type="hidden" name="sortColumn" id="hiddenSortColumn" value="<%= (typeof filters !== 'undefined' && filters.sortColumn) ? filters.sortColumn : '' %>">
                    <input type="hidden" name="sortOrder" id="hiddenSortOrder" value="<%= (typeof filters !== 'undefined' && filters.sortOrder) ? filters.sortOrder : 'asc' %>">

                    <!-- Hidden inputs to preserve filter states when searching -->
                    <input type="hidden" name="npsFilters" id="hiddenNpsFilters" value="">
                    <input type="hidden" name="commentsFilters" id="hiddenCommentsFilters" value="">
                </form>

                <!-- FILTER FORM -->
                <form id="filterForm" method="POST" action="/filter-surveys">
                    <div id="filterSection" class="advanced-filter-section is-hidden">
                        <h3 class="filter-options-title">Filter Options</h3>
                        <div class="filter-cards-grid">
                            <!-- NPS Bucket Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="filter-card-title">NPS Bucket</h4>
                                </div>
                                <div class="card-body filter-card-scroll">
                                    <%
                                        const npsFilters = (typeof filters !== 'undefined' && filters.nps) ? filters.nps : ['all'];
                                        const isNpsAll = npsFilters.includes('all');
                                    %>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="nps" value="all" class="nps-checkbox" <%= isNpsAll ? 'checked' : '' %>> All
                                    </label>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="nps" value="Promoter" class="nps-checkbox" <%= npsFilters.includes('Promoter') ? 'checked' : '' %>> Promoter
                                    </label>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="nps" value="Passive" class="nps-checkbox" <%= npsFilters.includes('Passive') ? 'checked' : '' %>> Passive
                                    </label>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="nps" value="Detractor" class="nps-checkbox" <%= npsFilters.includes('Detractor') ? 'checked' : '' %>> Detractor
                                    </label>
                                </div>
                            </div>

                            <!-- Comments Filter -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="filter-card-title">Has Comments</h4>
                                </div>
                                <div class="card-body">
                                    <%
                                        const commentsFilters = (typeof filters !== 'undefined' && filters.comments) ? filters.comments : ['all'];
                                        const isCommentsAll = commentsFilters.includes('all');
                                    %>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="comments" value="all" class="comments-checkbox" <%= isCommentsAll ? 'checked' : '' %>> All
                                    </label>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="comments" value="Yes" class="comments-checkbox" <%= commentsFilters.includes('Yes') ? 'checked' : '' %>> Has Comments
                                    </label>
                                    <label class="filter-checkbox-label">
                                        <input type="checkbox" name="comments" value="No" class="comments-checkbox" <%= commentsFilters.includes('No') ? 'checked' : '' %>> No Comments
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Buttons -->
                        <div class="filter-row filter-actions">
                            <div class="filter-item filter-actions-item">
                                <button type="submit" class="btn btn-primary btn-small btn-block">
                                    Apply Filters
                                </button>
                            </div>
                            <div class="filter-item filter-actions-item">
                                <button type="button" class="btn btn-outline btn-small btn-block" id="clearFilters">
                                    Clear Filters
                                </button>
                            </div>
                        </div>

                        <!-- Hidden inputs to preserve search + sort when filtering -->
                        <input type="hidden" name="searchColumn" id="filterSearchColumn" value="<%= (typeof filters !== 'undefined' && filters.searchColumn) ? filters.searchColumn : 'survey_id' %>">
                        <input type="hidden" name="searchValue" id="filterSearchValue" value="<%= (typeof filters !== 'undefined' && filters.searchValue) ? filters.searchValue : '' %>">
                        <input type="hidden" name="sortColumn" id="filterSortColumn" value="<%= (typeof filters !== 'undefined' && filters.sortColumn) ? filters.sortColumn : '' %>">
                        <input type="hidden" name="sortOrder" id="filterSortOrder" value="<%= (typeof filters !== 'undefined' && filters.sortOrder) ? filters.sortOrder : 'asc' %>">
                    </div>
                </form>
            </div>

            <!-- Bulk Actions Bar (optional future use) -->
            <div id="bulkActionsBar" style="display: none; background-color: #f8f0f0; padding: 1rem 1.5rem; border-bottom: 1px solid #e0e0e0;">
                <div class="flex-between">
                    <div>
                        <span id="selectedCount" style="font-weight: 600; color: #666;">0 selected</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-secondary btn-small" id="editSelected" style="display: none;"> Edit </button>
                        <button class="btn btn-danger btn-small" id="deleteSelected"> Delete Selected </button>
                        <button class="btn btn-outline btn-small" id="clearSelection"> Clear Selection</button>
                    </div>
                </div>
            </div>

            <!-- TABLE -->
            <div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                            <th class="sortable" data-column="survey_id">Survey ID <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="participant_event_id">Participant Event ID <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_satisfaction_score">Satisfaction <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_usefulness_score">Usefulness <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_instructor_score">Instructor <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_recommendation_score">Recommendation <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_overall_score">Overall <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_nps_bucket">NPS Bucket <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_comments">Comments <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_submission_date">Submission Date <span class="sort-icon">⇅</span></th>
                            <th class="sortable" data-column="survey_submission_time">Submission Time <span class="sort-icon">⇅</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (typeof survey !== 'undefined' && survey.length > 0) { %>
                            <% survey.forEach(function(s) { %>
                                <% 
                                    let formattedDate = '';
                                    if (s.survey_submission_date) {
                                        const d = new Date(s.survey_submission_date);
                                        const month = String(d.getMonth() + 1).padStart(2, '0');
                                        const day = String(d.getDate()).padStart(2, '0');
